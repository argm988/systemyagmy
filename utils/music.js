const e=require(process.cwd()+"/config/conf.json"),n=require(process.cwd()+"/config/messages.json"),i=require("ytdl-core"),r=require("simple-youtube-api"),o=new r(e.youtube.api.key),u=require("discord.js"),l=require(process.cwd()+"/classes/genius.js"),s=require(process.cwd()+"/utils/helpers.js"),d=new l(e.genius.api.token);let t={};async function a(e){try{t[e.guild.id].connection=await e.member.voice.channel.join(),t[e.guild.id].textChannel=e.channel,t[e.guild.id].voiceChannel=e.member.voice.channel}catch(n){console.log(n),t[e.guild.id].playing=!1,t[e.guild.id].songQueue=[],await s.sendError(e.channel,"An unexpected error occurred!","Check the console for more details")}}function c(e){t[e.guild.id].playing=!1,t[e.guild.id].songQueue=[],t[e.guild.id].voiceChannel.leave()}function g(e){isNaN(e)&&(e=parseInt(e,10));let n=Math.floor(e/3600),i=Math.floor((e-3600*n)/60),r=(e-3600*n-60*i).toFixed(0);return`${0!==n?n<10?`0${n}:`:`${n}:`:""}${i<10?`0${i}`:i}:${r<10?`0${r}`:r}`}function h(u,l){if(!u.member.voice.channel)return s.sendError(u.channel,n.errors.voiceChannel);if(t[u.guild.id]||(t[u.guild.id]={textChannel:null,voiceChannel:null,connection:null,dispatcher:null,songQueue:[],playing:!1,volume:1}),0===l.length)return s.sendError(u.channel,"Invalid Search",`\`${e.prefix}${e.commands.useMusicCommand?"music ":""}play <query>\``);if(e.music.maxQueue>0&&t[u.guild.id].songQueue.length+1>=e.music.maxQueue+1)return s.sendError(u.channel,n.errors.queue.replace("%queue%",e.music.maxQueue));async function d(e){try{let n=await i.getInfo(e),r=n.player_response.videoDetails;t[u.guild.id].songQueue.push({title:r.title,duration:r.lengthSeconds,thumbnail:`https://img.youtube.com/vi/${r.videoId}/maxresdefault.jpg`,url:n.videoDetails.video_url,loop:!1,requestedBy:u.author.id}),t[u.guild.id].songQueue.length>1?await s.sendEmbed(u.channel,"","Song Added",`[${r.title}](${n.videoDetails.video_url}) has been added to the queue`,[],"",`https://img.youtube.com/vi/${r.videoId}/maxresdefault.jpg`):await b(u).then(()=>m(u))}catch(e){return console.log(e),s.sendError(u.channel,"Invalid YouTube link!")}}n.music.search.hidden||s.sendEmbed(u.channel,"",n.music.search.title.replace("%search%",l.join(" ")),n.music.search.description.replace("%search%",l.join(" "))),/^https?:\/\/www\.youtube\.com\/.*\?.*\blist=.*/.test(l.join(" "))?o.getPlaylist(l.join(" ")).then(i=>{i.getVideos().then(r=>{let o=r.filter(e=>"video"===e.type).map(e=>({title:e.title,duration:e.durationSeconds,thumbnail:e.maxRes,url:e.url,requestedBy:u.author.id}));return e.music.maxQueue>0&&t[u.guild.id].songQueue.length+o.length>=e.music.maxQueue+1?s.sendError(u.channel,n.errors.queue.replace("%queue%",e.music.maxQueue)):(t[u.guild.id].songQueue=[...t[u.guild.id].songQueue,...o],s.sendEmbed(u.channel,"","Playlist Added",`${o.length} song(s) from [${i.title}](${l.join(" ")}) have been added to the queue`,[],"",i.thumbnails.standard.url),t[u.guild.id].playing?void 0:m(u))}).catch(e=>{console.log(e),s.sendError(u.channel,"An error occurred while retrieving playlist videos","Check the console for more details")})}).catch(e=>{403===e.code&&e.errors.find(e=>"accessNotConfigured"===e.reason)?s.sendError(u.channel,"The owner must enable the YouTube API to use playlists:",`${e.errors.find(e=>"accessNotConfigured"===e.reason).extendedHelp}`):e.message.includes("The request is missing a valid API key")||e.errors.find(e=>"keyInvalid"===e.reason)||e.errors.find(e=>"dailyLimitExceededUnreg"===e.reason)?s.sendError(u.channel,"The owner must generate an API key to use playlists:","[Click Me](https://developers.google.com/youtube/registering_an_application) to generate one."):(console.log(e),s.sendError(u.channel,"An unexpected error occurred!","Check the console for more details"))}):0!==Object.keys(r.util.parseURL(l.join(" "))).length?d(r.util.parseURL(l.join(" ")).video):o.searchVideos(l.join(" "),20,{type:"video"}).then(e=>{if(0===e.length)return s.sendError(u.channel,"No results for",`\`\`\`${l.join(" ")}\`\`\``);d((e.find(e=>e.title.split(" ").map(e=>e.toLowerCase()).some(e=>l.map(e=>e.toLowerCase()).includes(e)))||e[0]).id)}).catch(e=>{403===e.code&&e.errors.find(e=>"accessNotConfigured"===e.reason)?s.sendError(u.channel,"The owner must enable the YouTube API to enable the music search:",`${e.errors.find(e=>"accessNotConfigured"===e.reason).extendedHelp}`):e.message.includes("The request is missing a valid API key")||e.errors&&e.errors.find(e=>"keyInvalid"===e.reason)||e.errors&&e.errors.find(e=>"dailyLimitExceededUnreg"===e.reason)?s.sendError(u.channel,"The owner must generate an API key enable the music search:","[Click Me](https://developers.google.com/youtube/registering_an_application) to generate one."):(console.log(e),s.sendError(u.channel,"An unexpected error occurred!","Check the console for more details"))})}function m(n){if(!n.member.voice.channel.joinable)return s.sendError(n.channel,"Unable to join voice channel!","Do I have the required permissions?");if(!n.guild.voice||!n.guild.voice.connection||!t[n.guild.id].connection)return a(n).then(()=>{m(n)});try{const r=t[n.guild.id].connection.play(i(t[n.guild.id].songQueue[0].url,{quality:"highestaudio",highWaterMark:1e3*e.music.videoBuffer*1e3,filter:"audioonly"}));t[n.guild.id].dispatcher=r,r.on("start",()=>{r.setVolume(t[n.guild.id].volume),t[n.guild.id].playing=!0}),r.on("finish",()=>(t[n.guild.id].songQueue[0].loop||t[n.guild.id].songQueue.shift(),0===t[n.guild.id].songQueue.length?c(n):m(n))),r.on("error",e=>"input stream: Video unavailable"===e.message?(s.sendError(n.channel,"Could not play song! Skipping..."),t[n.guild.id]&&t[n.guild.id].playing&&1!==t[n.guild.id].songQueue.length?E(n):c(n)):(s.sendError(n.channel,"An unexpected error occurred while playing song!","Please try again"),console.log(e),c(n)))}catch(e){return console.log(e),s.sendError(n.channel,"An unexpected error occurred!",`\`\`\`${e}\`\`\``)}}function p(e){return e.member.voice.channel?t[e.guild.id]?(s.sendEmbed(e.channel,"",n.music.stop.title,n.music.stop.description),void c(e)):s.sendError(e.channel,n.errors.nothingPlaying):s.sendError(e.channel,n.errors.voiceChannel)}function y(e){return e.member.voice.channel?q(e.guild)?(t[e.guild.id].connection.dispatcher.pause(),void s.sendEmbed(e.channel,"",n.music.pause.title,n.music.pause.description)):s.sendError(e.channel,n.errors.nothingPlaying):s.sendError(e.channel,n.errors.voiceChannel)}function v(e){return e.member.voice.channel?q(e.guild)?(t[e.guild.id].connection.dispatcher.resume(),void s.sendEmbed(e.channel,"",n.music.resume.title,n.music.resume.description)):s.sendError(e.channel,n.errors.nothingPlaying):s.sendError(e.channel,n.errors.voiceChannel)}async function f(r){if(!r.member.voice.channel)return s.sendError(r.channel,n.errors.voiceChannel);if(!t[r.guild.id]||!t[r.guild.id].playing||0===t[r.guild.id].songQueue.length)return s.sendError(r.channel,n.errors.nothingPlaying);try{let n=(await i.getInfo(t[r.guild.id].songQueue[0].url)).player_response.videoDetails;await s.sendEmbed(r.channel,"","Currently Playing",`[${n.title}](${t[r.guild.id].songQueue[0].url})`,[{name:"Channel",value:n.author,inline:!0},{name:"​",value:"​",inline:!0},{name:"Requested By",value:r.client.users.cache.get(t[r.guild.id].songQueue[0].requestedBy)?r.client.users.cache.get(t[r.guild.id].songQueue[0].requestedBy).username:"?",inline:!0},{name:"Duration",value:g(n.lengthSeconds),inline:!0},{name:"​",value:"​",inline:!0},{name:"Views",value:parseInt(n.viewCount.toString()).toLocaleString("en-US"),inline:!0},...e.music.playingBar.enabled?[{name:"​",value:`[${[...[...Array(Math.floor(Math.min(t[r.guild.id].dispatcher.streamTime/1e3,n.lengthSeconds)/n.lengthSeconds*28)).keys()].map(()=>"■"),...[...Array(28-Math.floor(Math.min(t[r.guild.id].dispatcher.streamTime/1e3,n.lengthSeconds)/n.lengthSeconds*28)).keys()].map(()=>"□")].join("")}]\n\n\`${g(Math.min(t[r.guild.id].dispatcher.streamTime/1e3,n.lengthSeconds))} / ${g(n.lengthSeconds)}\``}]:[]],"",`https://img.youtube.com/vi/${n.videoId}/maxresdefault.jpg`)}catch(e){return console.log(e),s.sendError(r.channel,"An unexpected error occurred!",`\`\`\`${e}\`\`\``)}}function E(e){return e.member.voice.channel?t[e.guild.id]&&t[e.guild.id].playing&&0!==t[e.guild.id].songQueue.length?(t[e.guild.id].songQueue.shift(),void(t[e.guild.id].songQueue<=1?s.sendEmbed(e.channel,"",n.music.skip.end.title,n.music.skip.end.description):b(e).then(()=>m(e)))):s.sendError(e.channel,n.errors.nothingPlaying):s.sendError(e.channel,n.errors.voiceChannel)}async function b(e){try{let n=(await i.getInfo(t[e.guild.id].songQueue[0].url.toString())).player_response.videoDetails;await s.sendEmbed(e.channel,"","Now Playing",`[${n.title}](${t[e.guild.id].songQueue[0].url})`,[{name:"Channel",value:n.author,inline:!0},{name:"​",value:"​",inline:!0},{name:"Requested By",value:e.client.users.cache.get(t[e.guild.id].songQueue[0].requestedBy)?e.client.users.cache.get(t[e.guild.id].songQueue[0].requestedBy).username:"?",inline:!0},{name:"Duration",value:g(n.lengthSeconds),inline:!0},{name:"​",value:"​",inline:!0},{name:"Views",value:parseInt(n.viewCount.toString()).toLocaleString("en-US"),inline:!0}],"",`https://img.youtube.com/vi/${n.videoId}/maxresdefault.jpg`)}catch(n){return console.log(n),s.sendError(e.channel,"An unexpected error occurred!",`\`\`\`${n}\`\`\``)}}function $(i,r){return i.member.voice.channel?t[i.guild.id]&&t[i.guild.id].connection&&t[i.guild.id].connection.dispatcher?isNaN(r)?s.sendError(i.channel,`Invalid number: \`${r||"?"}\``):(t[i.guild.id].volume=Math.max(0,Math.min(parseFloat(r)/100,e.music.maxVolume/100)),t[i.guild.id].dispatcher.setVolume(t[i.guild.id].volume),void s.sendEmbed(i.channel,"",n.music.volume.title.replace("%percent%",`${100*t[i.guild.id].volume}%`),n.music.volume.description.replace("%percent%",`${100*t[i.guild.id].volume}`))):s.sendError(i.channel,"I am not linked to this voice channel",`Please run: \`${e.prefix}${e.commands.useMusicCommand?"music ":""}play <YouTube link>\` first`):s.sendError(i.channel,n.errors.voiceChannel)}function Q(e,i){if(!t[e.guild.id]||t[e.guild.id].songQueue.length<=1)return s.sendError(e.channel,n.music.queue.noQueue);let r=u.splitMessage(t[e.guild.id].songQueue.map((e,n)=>`${n+1}) [${e.title}](${e.url})`).join("\n"),{maxLength:1024});s.sendEmbed(e.channel,"",n.music.queue.title,r[isNaN(i)?0:i-1]||"End of queue",[],`Page ${[isNaN(i)?1:i]} of ${r.length}`)}function C(i,r){return isNaN(r)?s.sendError(i.channel,`Invalid number: \`${r||"?"}\`!`):t[i.guild.id]&&0!==t[i.guild.id].songQueue.length?r<=1?s.sendError(i.channel,"You may not remove the current song!",`Run \`${e.prefix}${e.commands.useMusicCommand?"music ":""}skip\` instead.`):t[i.guild.id].songQueue[r-1]?void s.sendEmbed(i.channel,"",n.music.remove.title.replace("%song%",t[i.guild.id].songQueue[r-1].title).replace("%url%",t[i.guild.id].songQueue[r-1].url),n.music.remove.description.replace("%song%",t[i.guild.id].songQueue[r-1].title).replace("%url%",t[i.guild.id].songQueue[r-1].url),[],"",t[i.guild.id].songQueue[r-1].thumbnail).then(()=>t[i.guild.id].songQueue.splice(r-1,1)):s.sendError(i.channel,"Song not found!","The song is not in the queue"):s.sendError(i.channel,"Nothing in the queue")}function w(e){if(!q(e.guild))return s.sendError(e.channel,n.errors.nothingPlaying);t[e.guild.id].songQueue[0].loop=!t[e.guild.id].songQueue[0].loop,s.sendEmbed(e.channel,"",(t[e.guild.id].songQueue[0].loop?n.music.loop.start:n.music.loop.end).title,(t[e.guild.id].songQueue[0].loop?n.music.loop.start:n.music.loop.end).description.replace("%song%",t[e.guild.id].songQueue[0].title).replace("%url%",t[e.guild.id].songQueue[0].url),[],"",t[e.guild.id].songQueue[0].thumbnail)}function x(i,r){let o=!r.join(" ")&&q(i.guild)?t[i.guild.id].songQueue[0].title:r.join(" ");if(!o)return s.sendError(i.channel,"Invalid Usage!",`\`${e.prefix}${e.commands.useMusicCommand?"music ":""}lyrics [song name]\``);n.music.lyrics.search.hidden||s.sendEmbed(i.channel,"",n.music.lyrics.search.title.replace("%search%",o),n.music.lyrics.search.description.replace("%search%",o)),d.getSong(o).then(e=>{d.getSongLyrics(e.result.url).then(e=>{if(!e.lyrics)return s.sendError(i.channel,"Lyrics not found!",`Could not find lyrics for \`${o}\``);s.sendEmbed(i.channel,"",`Lyrics for '${o}'`,`${e.lyrics}`,[],"").catch(n=>{if("Invalid Form Body\nembed.description: Must be 2048 or fewer in length."===n.message)return s.sendEmbed(i.channel,"",`Lyrics for '${o}'`,`The lyrics are too long! You may view them [Here](${e.url})`);s.sendError(i.channel,"An unexpected error occurred!",`\`\`\`${n.message}\`\`\``)})}).catch(e=>{console.log(e)})}).catch(n=>n.error&&"invalid_token"===n.error||!e.genius.api.token?s.sendError(i.channel,"The owner must create a Genius api key to enable lyrics! They may do so here:","https://docs.genius.com/#/getting-started-h1"):n.message.includes("Did not find any songs with name")?s.sendError(i.channel,"Song not found!",`Could not find lyrics for \`${o}\``):void console.log(n))}function q(e){return t[e.id]&&t[e.id].playing&&t[e.id].connection&&t[e.id].connection.dispatcher}module.exports={play:m,run:h,stop:p,pause:y,resume:v,currentPlaying:f,skip:E,setVolume:$,listQueue:Q,remove:C,loop:w,getLyrics:x};